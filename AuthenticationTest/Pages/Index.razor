@page "/"
@using Npgsql
@using System.Data
@using AuthenticationTest.Areas.Identity
@using AuthenticationTest.Data
@using AuthenticationTest.Data.Entities
@using Microsoft.AspNetCore.Http
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@inject IDAOFetcher _daoFetcher
@inject AuthenticationStateProvider auth
@inject Company TheCompany
@inject NavigationManager NavManager
@inject IJSRuntime JsRuntime

<h1>Hello, world!</h1>

Welcome to your new app.

<SurveyPrompt Title="How is Blazor working for you?"/>

@code
{
    protected override async Task OnInitializedAsync()
    {
        ifAuthenticated();
    }

    private async void ifAuthenticated()
    {
        // We check if the user is logged in
        bool isAuthenticated = auth.GetAuthenticationStateAsync().Result.User.Identity.IsAuthenticated;

        if (isAuthenticated)
        {
            // We check if company details are tied to user
            bool isTied = _daoFetcher.CompanyDao().userTiedToCompany(auth.GetAuthenticationStateAsync().Result.User.Identity.Name);

            if (isTied)
            {
                TheCompany.id = _daoFetcher.CompanyDao().getCompanyForUserById(auth.GetAuthenticationStateAsync().Result.User.Identity.Name).id;
            }
            else
            {
                await JsRuntime.InvokeVoidAsync("alert", "WELCOME! As this is the first time you are using this tool, please fill out company information.");
                NavManager.NavigateTo("CompanyEditor");
            }
        }
    }

}