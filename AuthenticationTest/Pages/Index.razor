@page "/"
@using Npgsql
@using System.Data
@using AuthenticationTest.Areas.Identity
@using AuthenticationTest.Data
@using AuthenticationTest.Data.Entities
@using Microsoft.AspNetCore.Http
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@inject IDAOFetcher _daoFetcher
@inject AuthenticationStateProvider auth
@inject Company TheCompany
@inject NavigationManager NavManager
@inject IJSRuntime JsRuntime

<div class="container">
    <div class="bd-example" style="width:100%; max-width:800px; height:100%; max-height:270px;">
        <div id="carouselExampleCaptions" class="carousel slide" data-ride="carousel">
            <ol class="carousel-indicators">
                <li data-target="#carouselExampleCaptions" data-slide-to="0" class="active"></li>
                <li data-target="#carouselExampleCaptions" data-slide-to="1"></li>
                <li data-target="#carouselExampleCaptions" data-slide-to="2"></li>
                <li data-target="#carouselExampleCaptions" data-slide-to="3"></li>
            </ol>
            <div class="carousel-inner">
                <div class="carousel-item active">
                    <img src="https://i.ibb.co/8DTZQLH/slide-4.png" class="d-block w-100">
                    <div class="carousel-caption d-none d-md-block" style="background-color: black; padding: 15px; opacity: 0.7; border-radius: 10px;">
                        <h5 style="">This guide isn't afraid to go off the beaten path</h5>
                        <p>TravelBuddy can give your visitors guided tours anywhere that has access to the internet!</p>
                    </div>
                </div>
                <div class="carousel-item">
                    <img src="https://i.ibb.co/yNP8YV6/slide-2.png" class="d-block w-100">
                    <div class="carousel-caption d-none d-md-block" style="background-color: black; padding: 15px; opacity: 0.7; border-radius: 10px;">
                        <h5>Roof or no roof</h5>
                        <p>TravelBuddy supports guided tours both indoors and outdoors.</p>
                    </div>
                </div>
                <div class="carousel-item">
                    <img src="https://i.ibb.co/Jz1nmYs/slide-3.png"  class="d-block w-100">
                    <div class="carousel-caption d-none d-md-block" style="background-color: black; padding: 15px; opacity: 0.7; border-radius: 10px;">
                        <h5>Ditch the crowd</h5>
                        <p>TravelBuddy allows users to get a tour in their own tempo - in their own order, which suits them best.</p>
                    </div>
                </div>
                <div class="carousel-item">
                    <img src="https://i.ibb.co/C94DnF1/slide-1.jpg" class="d-block w-100">
                    <div class="carousel-caption d-none d-md-block" style="background-color: black; padding: 15px; opacity: 0.7; border-radius: 10px;">
                        <h5>This guide is awake 24/7</h5>
                        <p>Early morning? Late night? TravelBuddy is always up and running, ready to guide you.</p>
                    </div>
                </div>
            </div>
            <a class="carousel-control-prev" href="#carouselExampleCaptions" role="button" data-slide="prev">
                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                <span class="sr-only">Previous</span>
            </a>
            <a class="carousel-control-next" href="#carouselExampleCaptions" role="button" data-slide="next">
                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                <span class="sr-only">Next</span>
            </a>
        </div>
    </div>
</div>

<div style="height: 300px;"></div>

<div class="container">
    <h1>Welcome to TravelBuddy!</h1>
</div>
<div class="container">
    <div style="text-align: center;">TravelBuddy let's your visitors get a guide - anywhere, anytime! Our unique platform supports any language in the world, and allows you to customize your tours on this site, which your visitors can then access.</div>
</div>
<br/>
<div class="container" hidden="@HideSignInPrompt">
    <h2>Sign up today:</h2>
</div>
<div class="container" hidden="@HideSignInPrompt">
    <a href="/Identity/Account/Login" class="button-3"  style="margin: 15px; padding: 20px; font-size: 150%;"><i style="vertical-align: middle; margin-right: 5px;" class="material-icons">add_box</i>   Sign up</a>
</div>
<br/>
<div class="container">
    <h2>Some of our partners</h2>
    </div>
<section class="section section-default mt-none mb-none">
    <div class="container">
        <strong>
            <div class="row">
                <div class="col-sm-6 col-md-4 col-lg-3">
                    <div class="square-holder">
                        <img alt="" src="https://i.ibb.co/3Cdw1VG/1519866539904.jpg" />
                    </div>
                </div>
                <div class="col-sm-6 col-md-4 col-lg-3">
                    <div class="square-holder">
                        <img alt="" src="https://i.ibb.co/pJXXXP7/1582291526293.jpg" />
                    </div>
                </div>
                <div class="col-sm-6 col-md-4 col-lg-3">
                    <div class="square-holder">
                        <img alt="" src="https://i.ibb.co/f8XfYL1/BO-A-Nationalp-Mols-Bjerge2.jpg" />
                    </div>
                </div>
                <div class="col-sm-6 col-md-4 col-lg-3">
                    <div class="square-holder">
                        <img alt="" src="https://i.ibb.co/swD5RGs/abildskou-mini1.jpg" />
                    </div>
                </div>
                <div class="col-sm-6 col-md-4 col-lg-3">
                    <div class="square-holder">
                        <img alt="" src="https://i.ibb.co/txYCPBx/denmarklogo-resized.jpg" />
                    </div>
                </div>
                <div class="col-sm-6 col-md-4 col-lg-3">
                    <div class="square-holder">
                        <img alt="" src="https://i.ibb.co/VMbVBNZ/download-1.png" />
                    </div>
                </div>
                <div class="col-sm-6 col-md-4 col-lg-3">
                    <div class="square-holder">
                        <img alt="" src="https://i.ibb.co/5Rk5tfd/download.png" />
                    </div>
                </div>
                <div class="col-sm-6 col-md-4 col-lg-3">
                    <div class="square-holder">
                        <img alt="" src="https://i.ibb.co/N38c0kY/unnamed.jpg" />
                    </div>
                </div>
            </div>
        </strong>
    </div>
</section>

@code
{
    private bool HideSignInPrompt = false;
    
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await JsRuntime.InvokeVoidAsync("startCarousels");
    }

    protected override async Task OnInitializedAsync()
    {
        ifAuthenticated();
    }

    private async void ifAuthenticated()
    {
        // We check if the user is logged in
        bool isAuthenticated = auth.GetAuthenticationStateAsync().Result.User.Identity.IsAuthenticated;

        if (isAuthenticated)
        {
            HideSignInPrompt = true;
            
            // We check if company details are tied to user
            bool isTied = _daoFetcher.CompanyDao().userTiedToCompany(auth.GetAuthenticationStateAsync().Result.User.Identity.Name);

            if (isTied)
            {
                TheCompany.id = _daoFetcher.CompanyDao().getCompanyForUserById(auth.GetAuthenticationStateAsync().Result.User.Identity.Name).id;
            }
            else
            {
                await JsRuntime.InvokeVoidAsync("alert", "WELCOME! As this is the first time you are using this tool, please fill out company information.");
                NavManager.NavigateTo("CompanyEditor");
            }
        }
    }
}